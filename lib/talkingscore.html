<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
    <title>Talking score for {{ basic_information['title'] }}</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="robots" content="noindex" />
    
    <script type='text/javascript' src='//www.midijs.net/lib/midi.js'></script> 

    <link href="http://127.0.0.1:8000/static/css/talkingscores.css" rel="stylesheet">

    <script>
        (function() {
            const theme = localStorage.getItem('theme-preference') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    
    <style type="text/css">
        body{font-family: Georgia; font-size: 26pt}
        
        h4 {
            margin-block-end:1rem;
        }
    </style>
</head>
<body class="score-page">

    <nav class="score-nav-ribbon">
        <a href="#" class="nav-link-top">Back to Top</a>
        <a href="#" id="stop-playback-btn" class="nav-link-stop">Stop Playback</a>
        <hr>
        <ul>
            {% for segment in music_segments %}
                <li>
                    <a href="#segment-{{ segment.start_bar }}">
                        {% if segment.start_bar == 'Pickup' %}
                            Pickup Bar
                        {% elif segment.start_bar == segment.end_bar %}
                            Bar {{ segment.start_bar }}
                        {% else %}
                            Bars {{ segment.start_bar }}-{{ segment.end_bar }}
                        {% endif %}
                    </a>
                </li>
            {% endfor %}
        </ul>
    </nav>
    <div class="container">
        <main id="score-main-content">
        <h1>Info</h1>

            <p>{{ basic_information['title']|default('Untitled work') }} by {{ basic_information['composer']|default('Unknown composer') }}.</p>

            <p class="signature-info">
                <span class="time-signature">Time signature: {{ preamble['time_signature'] }}</span>, 
                <span class="key-signature">Key signature: {{ preamble['key_signature'] }}</span>, 
                <span class="tempo-info">Tempo: {{ preamble['tempo']|default('no tempo specified') }}</span>
            </p>
            <p>Music, both hands, a bar at a time, beat by beat</p>

            <div id="global-controls">
                <h2>Entire score:</h2>
                <p>
                    Tempo:
                    <select class="ddlTempo" name="tempo">
                        <option value="50">50%</option>
                        <option value="100" selected>100%</option>
                        <option value="150">150%</option>
                    </select>
                    &nbsp; &nbsp;
                    Click:
                    <select class="ddlClick" name="click">
                        <option value="n">None</option>
                        <option value="be">Bars / Beats</option>
                    </select>
                </p>
                {% if play_all %}
                    <button type="button" class="lnkPlay btn-play" data-base-url="{{ full_score_midis.midi_all }}">
                        <span class="play-icon">▶</span> Play All Instruments
                    </button>
                {% endif %}
                {% if play_selected %}
                    <button type="button" class="lnkPlay btn-play" data-base-url="{{ full_score_midis.midi_sel }}">
                        <span class="play-icon">▶</span> Play Selected Instruments
                    </button>
                {% endif %}
                {% if play_unselected %}
                    <button type="button" class="lnkPlay btn-play" data-base-url="{{ full_score_midis.midi_un }}">
                        <span class="play-icon">▶</span> Play Unselected Instruments
                    </button>
                {% endif %}

                <h3>Instrument MIDIs</h3>
                {% for index, ins in full_score_midis.selected_instruments_midis.items() %}
                    {% if preamble.number_of_parts > 1 %}
                        <button type="button" class="lnkPlay btn-play" data-base-url="{{ ins.midi }}">
                            <span class="play-icon">▶</span> {{instruments[ins.ins][0]}}
                        </button>
                    {% else %}
                        <button type="button" class="lnkPlay btn-play" data-base-url="{{ ins.midi }}">
                            <span class="play-icon">▶</span> Play Score
                        </button>
                    {% endif %}
                    
                    {% if ins.midi_parts|length > 0 %}
                    <div class="instrument-parts">
                        {% for midipart in ins.midi_parts %}
                            <button type="button" class="lnkPlay btn-play btn-play-small" data-base-url="{{ midipart }}">
                                <span class="play-icon">▶</span> {{part_names[instruments[ins.ins][1] + loop.index-1 ]}}
                            </button>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>

        <h1>Summary:</h1>
        {{general_summary}}
        {% for summary in parts_summary %}
            <h3>{{selected_part_names[loop.index-1]}}</h3>
            {{summary}}
            <br/>
        {% endfor %}
        <br/>

        <h1>Music segment descriptions and playback</h1>
{% for segment in music_segments %}
<div id="segment-{{ segment.start_bar }}">
    <h2 class="bar-heading">
        {% if segment.start_bar == 'Pickup' %}
            <span class="bar-label">Pickup Bar</span>
        {% elif segment.start_bar == segment.end_bar %}
            <span class="bar-label">Bar {{ segment.start_bar }}</span>
        {% else %}
            <span class="bar-label">Bars {{ segment.start_bar }} to {{ segment.end_bar }}</span>
        {% endif %}
    </h2>

    <p>
        Tempo:
        <select class="ddlTempo" name="tempo">
            <option value="50">50%</option>
            <option value="100" selected>100%</option>
            <option value="150">150%</option>
        </select>
        &nbsp; &nbsp;
        Click:
        <select class="ddlClick" name="click">
            <option value="n">None</option>
            <option value="be">Bars / Beats</option>
        </select>
    </p>

    {% set segment_label = "bars " ~ segment.start_bar ~ " to " ~ segment.end_bar if segment.start_bar != 'Pickup' and segment.start_bar != segment.end_bar else "bar " ~ segment.start_bar if segment.start_bar != 'Pickup' else "Pickup Bar" %}
    {% if play_all %}
        <button type="button" class="lnkPlay btn-play" data-base-url="{{ segment.midi_all }}">
            <span class="play-icon">▶</span> Play All - {{ segment_label }}
        </button>
    {% endif %}
    {% if play_selected %}
        <button type="button" class="lnkPlay btn-play" data-base-url="{{ segment.midi_sel }}">
            <span class="play-icon">▶</span> Play Selected - {{ segment_label }}
        </button>
    {% endif %}
    {% if play_unselected %}
        <button type="button" class="lnkPlay btn-play" data-base-url="{{ segment.midi_un }}">
            <span class="play-icon">▶</span> Play Unselected - {{ segment_label }}
        </button>
    {% endif %}
    
    <h3>Instrument MIDIs</h3>
    {% for index, ins in segment.selected_instruments_midis.items() %}
        {% if preamble.number_of_parts > 1 %}
             <button type="button" class="lnkPlay btn-play" data-base-url="{{ ins.midi }}">
                <span class="play-icon">▶</span> {{instruments[ins.ins][0]}} - {{ segment_label }}
             </button>
        {% else %}
             <button type="button" class="lnkPlay btn-play" data-base-url="{{ ins.midi }}">
                <span class="play-icon">▶</span> Play Score - {{ segment_label }}
             </button>
        {% endif %}
        
        {% if ins.midi_parts|length > 0 %}
        <div class="instrument-parts">
            {% for midipart in ins.midi_parts %}
                <button type="button" class="lnkPlay btn-play btn-play-small" data-base-url="{{ midipart }}">
                    <span class="play-icon">▶</span> {{part_names[instruments[ins.ins][1] + loop.index-1 ]}}
                </button>
            {% endfor %}
        </div>
        {% endif %}
    {% endfor %}
    <br/>

    {% for instrument_index, part_descriptions in segment.selected_instruments_descriptions.items() %}
        {% if segment.selected_instruments_descriptions|length > 1 %}<h3>{{instruments[instrument_index][0]}}</h3>{% endif %}
        {% for part_description in part_descriptions %}
            {% set part_index = loop.index0 %}
            {% if part_descriptions|length > 1 %}<h4>{{part_names[instruments[instrument_index][1] + loop.index-1 ]}}</h4>{% endif %}

            {% for bar, time_point_list in part_description.items()|sort %}
                <p class="meta-info bar-info">
                    <strong class="bar-number">Bar: {{ bar }}</strong>
                </p>
                {% if bar in time_and_keys %}
                <div class="signature-changes">
                    {% for tk in time_and_keys[bar] %}
                        <p class="signature-change">{{ tk }}</p>
                    {% endfor %}
                </div>
                {% endif %}
                {% set detailed_info = repetition_in_contexts[instruments[instrument_index][1] + part_index].get(bar) %}
                {% set learning_info = immediate_repetition_contexts[instruments[instrument_index][1] + part_index].get(bar) %}
                {% if settings.repetition_mode == 'learning' and learning_info %}<div class="repetition-info">{{ learning_info.text }}</div>
                {% elif settings.repetition_mode == 'detailed' and detailed_info %}<div class="repetition-info"><strong>Repetition:</strong> {{ detailed_info }}</div>{% endif %}

                {% set N = namespace(has_renderable_event=false) %}
                {% for time_point in time_point_list %}{% for voice, events_in_voice in time_point.voices|dictsort %}{% for event in events_in_voice %}{% if event.__class__.__name__ in ['TSNote', 'TSChord'] %}{% set N.has_renderable_event = true %}{% endif %}{% endfor %}{% endfor %}{% endfor %}

                {% if not N.has_renderable_event %}
                    <p>(This part rests for the entire bar)</p>
                {% elif not (settings.repetition_mode == 'learning' and learning_info and learning_info.type == 'exact') %}
                    {%- if settings.beat_division == 'bar' or segment.start_bar == 'Pickup' -%}
                        <p class="beat-group"><span class="beat-content">
                        {%- set ns = namespace(previous_event=None, rendered_content=[]) -%}
                        {%- for time_point in time_point_list -%}
                            {%- set filtered = namespace(events=[], has_note_or_chord=false) -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- if event.__class__.__name__ in ['TSNote', 'TSChord'] -%}{%- set filtered.has_note_or_chord = true -%}{%- endif -%}{%- endfor -%}{%- endfor -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- set event_type = event.__class__.__name__ -%}{%- if filtered.has_note_or_chord -%}{%- if event_type in ['TSNote', 'TSChord', 'TSDynamic'] -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- else -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- endfor -%}{%- endfor -%}
                            {%- for event in filtered.events -%}
                                {%- set rendered_event = event.render(settings, ns.previous_event) -%}
                                {%- if rendered_event -%}
                                    {%- if ns.rendered_content -%},&nbsp;{%- endif -%}
                                    {{- rendered_event|join(' ') | safe -}}
                                    {%- set ns.rendered_content = ns.rendered_content + [rendered_event|join(' ')] -%}
                                    {%- set ns.previous_event = event -%}
                                {%- endif -%}
                            {%- endfor -%}
                        {%- endfor -%}
                        </span></p>
                    {%- else -%}
                        {%- set ns = namespace(current_integer_beat=0, previous_event=None, rendered_content=[]) -%}
                        {%- for time_point in time_point_list -%}
                            {%- set integer_beat = (time_point.beat - 0.001)|round|int if time_point.beat is number and time_point.beat > 0 else ns.current_integer_beat -%}
                            {%- if integer_beat > ns.current_integer_beat -%}
                                {%- if ns.rendered_content -%}</span></p>{%- endif -%}
                                <p class="beat-group"><strong>Beat {{ integer_beat }}:</strong> <span class="beat-content">
                                {%- set ns.current_integer_beat = integer_beat -%}
                                {%- set ns.rendered_content = [] -%}
                            {%- elif ns.rendered_content -%}, {% endif -%}
                            {%- set filtered = namespace(events=[], has_note_or_chord=false) -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- if event.__class__.__name__ in ['TSNote', 'TSChord'] -%}{%- set filtered.has_note_or_chord = true -%}{%- endif -%}{%- endfor -%}{%- endfor -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- set event_type = event.__class__.__name__ -%}{%- if filtered.has_note_or_chord -%}{%- if event_type in ['TSNote', 'TSChord', 'TSDynamic'] -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- else -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- endfor -%}{%- endfor -%}
                            {%- for event in filtered.events -%}
                                {%- set rendered_event = event.render(settings, ns.previous_event) -%}
                                {%- if rendered_event -%}
                                    {%- if not loop.first %} - together with {% endif -%}
                                    {{- rendered_event|join(' ') | safe -}}
                                    {%- set ns.rendered_content = ns.rendered_content + [rendered_event|join(' ')] -%}
                                    {%- set ns.previous_event = event -%}
                                {%- endif -%}
                            {%- endfor -%}
                        {%- endfor -%}
                        {%- if ns.rendered_content -%}</span></p>{%- endif -%}
                    {%- endif -%}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
</div>
{% endfor %}

        <a href="#score-nav-ribbon" class="skip-link">Back to navigation</a>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", (event) => {
            function updateLink(link) {
                const parentScope = link.closest('#global-controls, div[id^="segment-"]');
                if (!parentScope) return;

                const baseUrl = link.dataset.baseUrl;
                if (!baseUrl) return;

                const tempo = parentScope.querySelector('.ddlTempo').value;
                const click = parentScope.querySelector('.ddlClick').value;

                const finalUrl = `${baseUrl}&t=${tempo}&c=${click}`;
                link.dataset.finalUrl = finalUrl;
            }

            document.body.addEventListener('click', function(e) {
                if (e.target.matches('.lnkPlay')) {
                    e.preventDefault();
                    const urlToPlay = e.target.dataset.finalUrl;
                    if (urlToPlay) {
                        MIDIjs.play(urlToPlay);
                    } else {
                        console.error("No final URL found for this link.", e.target);
                    }
                }
            });

            document.body.addEventListener('change', function(e) {
                if (e.target.matches('.ddlTempo, .ddlClick')) {
                    const changedElement = e.target;
                    
                    if (changedElement.closest('#global-controls')) {
                        const isTempo = changedElement.matches('.ddlTempo');
                        const value = changedElement.value;
                        const selector = isTempo ? '.ddlTempo' : '.ddlClick';
                        document.querySelectorAll(selector).forEach(ddl => { ddl.value = value; });
                    }

                    document.querySelectorAll('.lnkPlay').forEach(updateLink);
                }
            });

            document.querySelectorAll('.lnkPlay').forEach(updateLink);
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const navRibbon = document.querySelector('.score-nav-ribbon');
            const ribbonLinks = document.querySelectorAll('.score-nav-ribbon li a');
            const segments = document.querySelectorAll('div[id^="segment-"]');
            const stopBtn = document.getElementById('stop-playback-btn');
            if (stopBtn) {
                stopBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    MIDIjs.stop();
                });
            }

            if (navRibbon) {
                navRibbon.addEventListener('click', function(event) {
                    const targetLink = event.target.closest('a');
                    if (!targetLink) return;

                    const href = targetLink.getAttribute('href');
                    if (href === '#') {
                        event.preventDefault();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        history.replaceState(null, null, ' ');
                        return;
                    }

                    const targetElement = document.querySelector(href);
                    if (targetElement) {
                        event.preventDefault();
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        history.replaceState(null, null, href);
                    }
                });
            }

            if ('IntersectionObserver' in window && segments.length > 0 && ribbonLinks.length > 0) {
                const observerOptions = {
                    root: null, 
                    rootMargin: '0px 0px -50% 0px',
                    threshold: 0
                };

                const observer = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        const segmentId = entry.target.getAttribute('id');
                        const correspondingLink = document.querySelector(`.score-nav-ribbon li a[href="#${segmentId}"]`);
                        
                        if (entry.isIntersecting && correspondingLink) {
                            ribbonLinks.forEach(link => link.classList.remove('active'));
                            correspondingLink.classList.add('active');
                        }
                    });
                }, observerOptions);

                segments.forEach(segment => {
                    observer.observe(segment);
                });
            }
        });
    </script>
</body>
</html>