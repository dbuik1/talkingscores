<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
    <title>Talking score for {{ basic_information['title'] }}</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="robots" content="noindex" />
    
    <script type='text/javascript' src='//www.midijs.net/lib/midi.js'></script> 

    <link href="http://127.0.0.1:8000/static/css/talkingscores.css" rel="stylesheet">

    <script>
      (function() {
        const theme = localStorage.getItem('theme-preference') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
    
    <style type="text/css">
        /* You can keep these styles as a fallback, but the external CSS will take priority */
        body{font-family: Georgia; font-size: 26pt}
        
        h4 {
            margin-block-end:1rem;
        }
    </style>
    <script>
        (function() {
          // Check for a saved theme in localStorage, or default to light
          const theme = localStorage.getItem('theme-preference') || 'light';
          // Apply the theme to the root <html> element
          document.documentElement.setAttribute('data-theme', theme);
        })();
      </script>
</head>
<body class="score-page">

<h1>Info</h1>

<p>{{ basic_information['title']|default('Untitled work') }} by {{ basic_information['composer']|default('Unknown composer') }}.</p>

<p>Time signature of {{ preamble['time_signature'] }}, key signature of {{ preamble['key_signature'] }}, tempo of {{ preamble['tempo']|default('no tempo specified') }}</p>
<p>Music, both hands, a bar at a time, beat by beat</p>

<h2>Entire score:</h2>
<p>
    Tempo:
    <select class="ddlTempo" name="tempo" id="ddlTempo">
        <option value="50">50%</option>
        <option value="100" selected>100%</option>
        <option value="150">150%</option>
    </select>
    &nbsp; &nbsp;
    Click:
    <select class="ddlClick" name="click" id="ddlClick">
        <option value="n">None</option>
        <option value="be">Bars / Beats</option>
    </select>
</p>
{% if play_all %}
    <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ full_score_midis.midi_all + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play All Instruments </a>
    <br/>
{% endif %}
{% if play_selected %}
    <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ full_score_midis.midi_sel + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Selected Instruments </a>
    <br/>
{% endif %}
{% if play_unselected %}
    <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ full_score_midis.midi_un + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Unselected Instruments</a>
    <br/>
{% endif %}

<h3>Instrument MIDIs</h3>
{% for index, ins in full_score_midis.selected_instruments_midis.items() %}
    <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ ins.midi + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play - {{instruments[ins.ins][0]}} </a><br/>
    <li style="margin-left:15px; list-style-type:none;">
        {% for midipart in ins.midi_parts %}
            <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ midipart + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">{{part_names[instruments[ins.ins][1] + loop.index-1 ]}}  </a><br/>
        {% endfor %}
    </li>
{% endfor %}


<h1>Stop Music Playback</h1>
<a href="#" onClick="MIDIjs.stop(); return false;">Stop playback</a>

<h1>Summary:</h1>
{{general_summary}}
{% for summary in parts_summary %}
    <h3>{{selected_part_names[loop.index-1]}}</h3>
    {{summary}}
    <br/>
{% endfor %}
<br/>

<h1>Music segment descriptions and playback</h1>
{% for segment in music_segments %}

    {# --- CORRECTED HEADING LOGIC --- #}
    <h2>
        {% if segment.start_bar == 'Pickup' %}
            Pickup Bar
        {% else %}
            Bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %}
        {% endif %}
    </h2>

    <p>
        Tempo:
        <select class="ddlTempo" name="tempo">
            <option value="50">50%</option>
            <option value="100" selected>100%</option>
            <option value="150">150%</option>
        </select>
        &nbsp; &nbsp;
        Click:
        <select class="ddlClick" name="click">
            <option value="n">None</option>
            <option value="be">Bars / Beats</option>
        </select>
    </p>

    {# --- CORRECTED MIDI LINK LABELS --- #}
    {% set segment_label = "bars " ~ segment.start_bar ~ " to " ~ segment.end_bar if segment.start_bar != 'Pickup' and segment.start_bar != segment.end_bar else "bar " ~ segment.start_bar if segment.start_bar != 'Pickup' else "Pickup Bar" %}
    {% if play_all %}
        <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ segment.midi_all + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play All - {{ segment_label }}</a>
        <br/>
    {% endif %}
    {% if play_selected %}
        <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ segment.midi_sel + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Selected - {{ segment_label }}</a>
        <br/>
    {% endif %}
    {% if play_unselected %}
        <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ segment.midi_un + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Unselected - {{ segment_label }}</a>
        <br/>
    {% endif %}
    
    <h3>Instrument MIDIs</h3>
    {% for index, ins in segment.selected_instruments_midis.items() %}
        <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ ins.midi + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play - {{instruments[ins.ins][0]}} - {{ segment_label }}</a><br/>
        <li style="margin-left:15px; list-style-type:none;">
            {% for midipart in ins.midi_parts %}
                <a href="#" class="lnkPlay" onClick="MIDIjs.play('{{ midipart + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">{{part_names[instruments[ins.ins][1] + loop.index-1 ]}}  </a><br/>
            {% endfor %}
        </li>
    {% endfor %}
    <br/>

    {# --- START: FINAL RENDERING LOGIC --- #}
    {% for instrument_index, part_descriptions in segment.selected_instruments_descriptions.items() %}
        {% if segment.selected_instruments_descriptions|length > 1 %}
            <h3>{{instruments[instrument_index][0]}}</h3>
        {% endif %}
        {% for part_description in part_descriptions %}
            {% set part_index = loop.index0 %}
            {% if part_descriptions|length > 1 %}
                <h4>{{part_names[instruments[instrument_index][1] + loop.index-1 ]}}</h4>
            {% endif %}
            
            {% for bar, time_point_list in part_description.items() %}
                {# --- CORRECTED BAR LABEL --- #}
                <h5>Bar: {% if segment.start_bar == 'Pickup' %}Pickup{% else %}{{ bar }}{% endif %}</h5>

                {% if bar in time_and_keys %}
                    <p class="meta-info">
                    {% for tk in time_and_keys[bar] %}{{tk}}<br/>{% endfor %}
                    </p>
                {% endif %}
                
                {% set detailed_info = repetition_in_contexts[instruments[instrument_index][1] + part_index].get(bar) %}
                {% set learning_info = immediate_repetition_contexts[instruments[instrument_index][1] + part_index].get(bar) %}

                {% if settings.repetition_mode == 'learning' and learning_info %}
                    <div class="repetition-info">{{ learning_info.text }}</div>
                {% elif settings.repetition_mode == 'detailed' and detailed_info %}
                    <div class="repetition-info"><strong>Repetition:</strong> {{ detailed_info }}</div>
                {% endif %}

                {% if not (settings.repetition_mode == 'learning' and learning_info and learning_info.type == 'exact') %}
                    {# --- SPECIAL CASE FOR PICKUP BAR (NO BEAT NUMBERS) --- #}
                    {% if segment.start_bar == 'Pickup' %}
                        <p class="beat-group"><span class="beat-content">
                        {% set ns = namespace(previous_event=None) %}
                        {% for time_point in time_point_list %}
                            {% if not loop.first %} {% endif %}
                            {% for voice, events_in_voice in time_point.voices|dictsort %}
                                {% if not loop.first %} - together with {% endif %}
                                {% for event in events_in_voice %}
                                    {% if not loop.first %}, {% endif %}
                                    {{ event.render(settings, ns.previous_event)|join(' ') | safe }}
                                    {% set ns.previous_event = event %}
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                        .</span></p>
                    {# --- LOGIC FOR REGULAR BARS (WITH BEAT NUMBERS) --- #}
                    {% else %}
                        {% set ns = namespace(current_integer_beat=0, previous_event=None, is_first_event_in_bar=True) %}
                        {% for time_point in time_point_list %}
                            {% set integer_beat = 0 %}
                            {% if time_point.beat is number and time_point.beat > 0 %}
                                {% set integer_beat = (time_point.beat - 0.001)|round|int %}
                            {% else %}
                                {% set integer_beat = ns.current_integer_beat %}
                            {% endif %}

                            {% if integer_beat > ns.current_integer_beat %}
                                {% if not ns.is_first_event_in_bar %}
                                    </span></p>
                                {% endif %}
                                <p class="beat-group"><strong>Beat {{ integer_beat }}:</strong> <span class="beat-content">
                                {% set ns.current_integer_beat = integer_beat %}
                            {% elif not ns.is_first_event_in_bar %}
                            , 
                            {% endif %}

                            {% for voice, events_in_voice in time_point.voices|dictsort %}
                                {% if not loop.first %} - together with {% endif %}
                                {% for event in events_in_voice %}
                                    {% if not loop.first %}, {% endif %}
                                    {{ event.render(settings, ns.previous_event)|join(' ') | safe }}
                                    {% set ns.previous_event = event %}
                                {% endfor %}
                            {% endfor %}
                            {% set ns.is_first_event_in_bar = False %}
                        {% endfor %}
                        {% if not ns.is_first_event_in_bar %}</span></p>{% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
    {# --- END: FINAL RENDERING LOGIC --- #}
{% endfor %}

{#<script type="text/javascript">#}
{##}
{#    window.onload = function () {#}
{#        MIDI.loadPlugin({#}
{#            soundfontUrl: "../lib/MIDI.js/soundfont/",#}
{#            instrument: "acoustic_grand_piano",#}
{#            callback: function () {#}
{#                var delay = 0; // play one note every quarter second#}
{#                var note = 50; // the MIDI note#}
{#                var velocity = 127; // how hard the note hits#}
{#                // play the note#}
{#                MIDI.setVolume(0, 127);#}
{#                MIDI.noteOn(0, note, velocity, delay);#}
{#                MIDI.noteOff(0, note, delay + 0.75);#}
{#            }#}
{#        });#}
{#    };#}
{##}
{#</script>#}

<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        document.querySelectorAll('.ddlTempo').forEach((ddlTempo) => {
            ddlTempo.addEventListener("change", function(event) {
                event.stopPropagation();
                event.stopImmediatePropagation();
                let tempo = ddlTempo.value;
                let ddlClick = document.querySelector("#ddlClick") 
                let click = ddlClick.value;
                
                document.querySelectorAll('.lnkPlay').forEach((lnkPlay) => {
                    let href = lnkPlay.getAttribute("onClick")
                    let posTempo = href.indexOf("&t=")
                    href = href.substr(0,posTempo)
                    lnkPlay.setAttribute('onClick', href +"&t="+ tempo + "&c=" + click + "&bsi={{binary_selected_instruments}}&bpi={{binary_play_all}}'); return false;") 
                })
                
                document.querySelectorAll('.ddlTempo').forEach((ddlTempo2) => {
                    ddlTempo2.value = ddlTempo.value
                })
            })
        }) 

        //click drop downs
        document.querySelectorAll('.ddlClick').forEach((ddlClick) => {
            ddlClick.addEventListener("change", function(event) {
                event.stopPropagation();
                event.stopImmediatePropagation();
                let click = ddlClick.value;
                let ddlTempo = document.querySelector("#ddlTempo") 
                let tempo = ddlTempo.value;
                
                document.querySelectorAll('.lnkPlay').forEach((lnkPlay) => {
                    let href = lnkPlay.getAttribute("onClick")
                    let posTempo = href.indexOf("&t=")
                    href = href.substr(0,posTempo)
                    lnkPlay.setAttribute('onClick', href +"&t="+ tempo + "&c=" + click + "&bsi={{binary_selected_instruments}}&bpi={{binary_play_all}}'); return false;") 
                })
                
                document.querySelectorAll('.ddlClick').forEach((ddlClick2) => {
                    ddlClick2.value = ddlClick.value
                })
            })
        }) 
    })

</script>
</body>
</html>