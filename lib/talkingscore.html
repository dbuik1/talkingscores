<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
    <title>Talking score for {{ basic_information['title'] }}</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="robots" content="noindex" />
    
    <script type='text/javascript' src='//www.midijs.net/lib/midi.js'></script> 

    <link href="http://127.0.0.1:8000/static/css/talkingscores.css" rel="stylesheet">

    <script>
      (function() {
        const theme = localStorage.getItem('theme-preference') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
    
    <style type="text/css">
        /* You can keep these styles as a fallback, but the external CSS will take priority */
        body{font-family: Georgia; font-size: 26pt}
        
        h4 {
            margin-block-end:1rem;
        }
    </style>
    <script>
        (function() {
          // Check for a saved theme in localStorage, or default to light
          const theme = localStorage.getItem('theme-preference') || 'light';
          // Apply the theme to the root <html> element
          document.documentElement.setAttribute('data-theme', theme);
        })();
      </script>
</head>
<body class="score-page">

<h1>Info</h1>

<p>{{ basic_information['title']|default('Untitled work') }} by {{ basic_information['composer']|default('Unknown composer') }}.</p>

<p>Time signature of {{ preamble['time_signature'] }}, key signature of {{ preamble['key_signature'] }}, tempo of {{ preamble['tempo']|default('no tempo specified') }}</p>
<p>Music, both hands, a bar at a time, beat by beat</p>

<div id="global-controls">
    <h2>Entire score:</h2>
    <p>
        Tempo:
        <select class="ddlTempo" name="tempo">
            <option value="50">50%</option>
            <option value="100" selected>100%</option>
            <option value="150">150%</option>
        </select>
        &nbsp; &nbsp;
        Click:
        <select class="ddlClick" name="click">
            <option value="n">None</option>
            <option value="be">Bars / Beats</option>
        </select>
    </p>
    {% if play_all %}
        <a href="#" class="lnkPlay" data-base-url="{{ full_score_midis.midi_all }}">Play All Instruments </a>
        <br/>
    {% endif %}
    {% if play_selected %}
        <a href="#" class="lnkPlay" data-base-url="{{ full_score_midis.midi_sel }}">Play Selected Instruments </a>
        <br/>
    {% endif %}
    {% if play_unselected %}
        <a href="#" class="lnkPlay" data-base-url="{{ full_score_midis.midi_un }}">Play Unselected Instruments</a>
        <br/>
    {% endif %}

    <h3>Instrument MIDIs</h3>
    {% for index, ins in full_score_midis.selected_instruments_midis.items() %}
        <a href="#" class="lnkPlay" data-base-url="{{ ins.midi }}">Play - {{instruments[ins.ins][0]}} </a><br/>
        <li style="margin-left:15px; list-style-type:none;">
            {% for midipart in ins.midi_parts %}
                <a href="#" class="lnkPlay" data-base-url="{{ midipart }}">{{part_names[instruments[ins.ins][1] + loop.index-1 ]}} </a><br/>
            {% endfor %}
        </li>
    {% endfor %}
</div>


<h1>Stop Music Playback</h1>
<a href="#" onClick="MIDIjs.stop(); return false;">Stop playback</a>

<h1>Summary:</h1>
{{general_summary}}
{% for summary in parts_summary %}
    <h3>{{selected_part_names[loop.index-1]}}</h3>
    {{summary}}
    <br/>
{% endfor %}
<br/>

<h1>Music segment descriptions and playback</h1>
{% for segment in music_segments %}

<div id="segment-{{ segment.start_bar }}">
    <h2>
        {% if segment.start_bar == 'Pickup' %}
            Pickup Bar
        {% else %}
            Bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %}
        {% endif %}
    </h2>

    <p>
        Tempo:
        <select class="ddlTempo" name="tempo">
            <option value="50">50%</option>
            <option value="100" selected>100%</option>
            <option value="150">150%</option>
        </select>
        &nbsp; &nbsp;
        Click:
        <select class="ddlClick" name="click">
            <option value="n">None</option>
            <option value="be">Bars / Beats</option>
        </select>
    </p>

    {% set segment_label = "bars " ~ segment.start_bar ~ " to " ~ segment.end_bar if segment.start_bar != 'Pickup' and segment.start_bar != segment.end_bar else "bar " ~ segment.start_bar if segment.start_bar != 'Pickup' else "Pickup Bar" %}
    {% if play_all %}
        <a href="#" class="lnkPlay" data-base-url="{{ segment.midi_all }}">Play All - {{ segment_label }}</a><br/>
    {% endif %}
    {% if play_selected %}
        <a href="#" class="lnkPlay" data-base-url="{{ segment.midi_sel }}">Play Selected - {{ segment_label }}</a><br/>
    {% endif %}
    {% if play_unselected %}
        <a href="#" class="lnkPlay" data-base-url="{{ segment.midi_un }}">Play Unselected - {{ segment_label }}</a><br/>
    {% endif %}
    
    <h3>Instrument MIDIs</h3>
    {% for index, ins in segment.selected_instruments_midis.items() %}
        <a href="#" class="lnkPlay" data-base-url="{{ ins.midi }}">Play - {{instruments[ins.ins][0]}} - {{ segment_label }}</a><br/>
        <li style="margin-left:15px; list-style-type:none;">
            {% for midipart in ins.midi_parts %}
                <a href="#" class="lnkPlay" data-base-url="{{ midipart }}">{{part_names[instruments[ins.ins][1] + loop.index-1 ]}}</a><br/>
            {% endfor %}
        </li>
    {% endfor %}
    <br/>

    {% for instrument_index, part_descriptions in segment.selected_instruments_descriptions.items() %}
        {% if segment.selected_instruments_descriptions|length > 1 %}<h3>{{instruments[instrument_index][0]}}</h3>{% endif %}
        {% for part_description in part_descriptions %}
            {% set part_index = loop.index0 %}
            {% if part_descriptions|length > 1 %}<h4>{{part_names[instruments[instrument_index][1] + loop.index-1 ]}}</h4>{% endif %}

            {% for bar, time_point_list in part_description.items() %}
                <h5>Bar: {% if segment.start_bar == 'Pickup' %}Pickup{% else %}{{ bar }}{% endif %}</h5>
                {% if bar in time_and_keys %}<p class="meta-info">{% for tk in time_and_keys[bar] %}{{tk}}<br/>{% endfor %}</p>{% endif %}
                {% set detailed_info = repetition_in_contexts[instruments[instrument_index][1] + part_index].get(bar) %}
                {% set learning_info = immediate_repetition_contexts[instruments[instrument_index][1] + part_index].get(bar) %}
                {% if settings.repetition_mode == 'learning' and learning_info %}<div class="repetition-info">{{ learning_info.text }}</div>
                {% elif settings.repetition_mode == 'detailed' and detailed_info %}<div class="repetition-info"><strong>Repetition:</strong> {{ detailed_info }}</div>{% endif %}

                {# Pre-check if there are any notes or chords to render for this bar #}
                {% set N = namespace(has_renderable_event=false) %}
                {% for time_point in time_point_list %}
                    {% for voice, events_in_voice in time_point.voices|dictsort %}
                        {% for event in events_in_voice %}
                            {% if event.__class__.__name__ in ['TSNote', 'TSChord'] %}
                                {% set N.has_renderable_event = true %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}

                {% if not N.has_renderable_event %}
                    <p>(This part rests for the entire bar)</p>
                {% elif not (settings.repetition_mode == 'learning' and learning_info and learning_info.type == 'exact') %}
                {%- if settings.beat_division == 'bar' or segment.start_bar == 'Pickup' -%}
                {# Renders the bar as one continuous paragraph #}
                <p class="beat-group"><span class="beat-content">
                {%- set ns = namespace(previous_event=None, is_first_event_in_bar=True) -%}
                {%- for time_point in time_point_list -%}
                    {%- set filtered = namespace(events=[], has_note_or_chord=false) -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- if event.__class__.__name__ in ['TSNote', 'TSChord'] -%}{%- set filtered.has_note_or_chord = true -%}{%- endif -%}{%- endfor -%}{%- endfor -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- set event_type = event.__class__.__name__ -%}{%- if filtered.has_note_or_chord -%}{%- if event_type in ['TSNote', 'TSChord', 'TSDynamic'] -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- else -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- endfor -%}{%- endfor -%}
                    {%- for event in filtered.events -%}
                        {%- set rendered_event = event.render(settings, ns.previous_event) -%}
                        {%- if rendered_event -%}
                        {%- if not ns.is_first_event_in_bar -%},&nbsp;{%- endif -%}
                            {{- rendered_event|join(' ') | safe -}}
                            {%- set ns.previous_event = event -%}
                            {%- set ns.is_first_event_in_bar = false -%}
                        {%- endif -%}
                    {%- endfor -%}
                {%- endfor -%}
                </span></p>
                    {%- else -%}
                        {# Renders the bar beat-by-beat #}
                        {%- set ns = namespace(current_integer_beat=0, previous_event=None, is_first_event_in_bar=True) -%}
                        {%- for time_point in time_point_list -%}
                            {%- set integer_beat = (time_point.beat - 0.001)|round|int if time_point.beat is number and time_point.beat > 0 else ns.current_integer_beat -%}
                            {%- if integer_beat > ns.current_integer_beat -%}
                                {%- if not ns.is_first_event_in_bar -%}</span></p>{%- endif -%}
                                <p class="beat-group"><strong>Beat {{ integer_beat }}:</strong> <span class="beat-content">
                                {%- set ns.current_integer_beat = integer_beat -%}
                            {%- elif not ns.is_first_event_in_bar -%}, {% endif -%}
                            {%- set filtered = namespace(events=[], has_note_or_chord=false) -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- if event.__class__.__name__ in ['TSNote', 'TSChord'] -%}{%- set filtered.has_note_or_chord = true -%}{%- endif -%}{%- endfor -%}{%- endfor -%}{%- for voice, events_in_voice in time_point.voices|dictsort -%}{%- for event in events_in_voice -%}{%- set event_type = event.__class__.__name__ -%}{%- if filtered.has_note_or_chord -%}{%- if event_type in ['TSNote', 'TSChord', 'TSDynamic'] -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- else -%}{%- set filtered.events = filtered.events + [event] -%}{%- endif -%}{%- endfor -%}{%- endfor -%}
                            {%- for event in filtered.events -%}
                                {%- if not loop.first %} - together with {% endif -%}
                                {{- event.render(settings, ns.previous_event)|join(' ') | safe -}}
                                {%- set ns.previous_event = event -%}
                            {%- endfor -%}
                            {%- set ns.is_first_event_in_bar = false -%}
                        {%- endfor -%}
                        {%- if not ns.is_first_event_in_bar -%}</span></p>{%- endif -%}
                    {%- endif -%}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
    </div>
{% endfor %}

<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        // This function builds the final URL for a link based on its dropdowns
        function updateLink(link) {
            const parentScope = link.closest('#global-controls, div[id^="segment-"]');
            if (!parentScope) return;

            const baseUrl = link.dataset.baseUrl;
            if (!baseUrl) return;

            const tempo = parentScope.querySelector('.ddlTempo').value;
            const click = parentScope.querySelector('.ddlClick').value;

            // The python functions create the base URL with its specific params (sel, part, etc.)
            // We just add the tempo and click params.
            const finalUrl = `${baseUrl}&t=${tempo}&c=${click}`;
            
            // Store the final, ready-to-play URL in a data attribute.
            link.dataset.finalUrl = finalUrl;
        }

        // Add a single click listener to the body for all playback links
        document.body.addEventListener('click', function(e) {
            if (e.target.matches('.lnkPlay')) {
                e.preventDefault(); // This reliably stops the page from jumping
                const urlToPlay = e.target.dataset.finalUrl;
                if (urlToPlay) {
                    MIDIjs.play(urlToPlay);
                } else {
                    console.error("No final URL found for this link.", e.target);
                }
            }
        });

        // Add a single change listener for all dropdowns
        document.body.addEventListener('change', function(e) {
            if (e.target.matches('.ddlTempo, .ddlClick')) {
                const changedElement = e.target;
                
                // If a global control was changed, sync all other dropdowns
                if (changedElement.closest('#global-controls')) {
                    const isTempo = changedElement.matches('.ddlTempo');
                    const value = changedElement.value;
                    const selector = isTempo ? '.ddlTempo' : '.ddlClick';
                    document.querySelectorAll(selector).forEach(ddl => { ddl.value = value; });
                }

                // Update all links on the page after any dropdown change to keep them in sync
                document.querySelectorAll('.lnkPlay').forEach(updateLink);
            }
        });

        // Initialize all links when the page first loads
        document.querySelectorAll('.lnkPlay').forEach(updateLink);
    });
</script>
</body>
</html>