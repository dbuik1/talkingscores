{% extends "base_site.html" %}
{% load static %}

{% block title %}Options - Talking Scores (Beta){% endblock %}
{% block noindex %}<meta name="robots" content="noindex" />{% endblock %}

{% block content %}
<style>
    .color-preview {
        padding: 2px 8px;
        border-radius: 4px;
        font-family: monospace;
        border: 1px solid transparent;
        transition: color 0.2s, background-color 0.2s;
        margin-left: auto; /* Pushes the preview to the right */
    }
    /* Style for disabled color pickers */
    input[type="color"]:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    .checkbox label {
        margin-right: 1rem; /* Adds some space between the label and the preview */
    }
</style>

    <div class="col-md-9 mx-auto text-start">

        <div id="sticky-preview-container">
            <div class="preview-block">
                <h5>Current Settings Preview</h5>
                <p class="active-profile-display">Active Profile: <strong id="active-profile-name">Default</strong></p>
                <div id="live-preview-content" class="preview-block-content"></div>
            </div>
        </div>

    {% if form.non_field_errors or form.errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            {{ form.non_field_errors }}
            {{ form.errors }}
        </div>
    {% endif %}

    <div class="text-center mb-4">
        <h1>{{ score_info.title }}</h1>
        <p class="lead text-muted">by {{ score_info.composer }}</p>
    </div>

    <form class="form-horizontal" method="post">
        {% csrf_token %}

        <fieldset class="mb-4">
            <legend class="h2 bold text-center">Choose Your Experience</legend>
            <p class="text-center text-muted mb-4">Select a preset to start. You can fine-tune settings in the "Advanced Options" section.</p>
            <div class="preset-card-container">
                <div class="preset-card active" id="preset-card-default" data-preset="default" tabindex="0">
                    <h4 class="preset-card-title">Default</h4>
                    <p class="preset-card-desc">A balanced description with rhythm, rests, and repetition analysis. Great for general use.</p>
                    
                </div>
                <div class="preset-card" id="preset-card-notes_only" data-preset="notes_only" tabindex="0">
                    <h4 class="preset-card-title">Notes Only</h4>
                    <p class="preset-card-desc">A minimal description focusing only on pitches. Hides rests, ties, and dynamics.</p>
                    
                </div>
                <div class="preset-card disabled" id="preset-card-custom" data-preset="custom">
                    <h4 class="preset-card-title">Custom</h4>
                    <p class="preset-card-desc">Your settings have been loaded or modified from a preset.</p>
                    
                </div>
            </div>
        </fieldset>
        
        <details class="advanced-options-container" open>
            <summary class="advanced-options-summary">Advanced Options</summary>
            
            <fieldset class="mb-4">
                <legend class="h4 bold">Playback &amp; Instruments</legend>
                <div class="form-group">
                    <div class="checkbox"><input type="checkbox" name="chk_playAll" id="chk_playAll" value="checked" checked="checked" aria-label="Play all parts together"/><label for="chk_playAll">Play all parts together</label></div>
                    <div class="checkbox"><input type="checkbox" name="chk_playSelected" id="chk_playSelected" value="checked" checked="checked" aria-label="Play all selected parts together"/><label for="chk_playSelected">Play all selected parts together</label></div>
                    <div class="checkbox"><input type="checkbox" name="chk_playUnselected" id="chk_playUnselected" value="checked" checked="checked" aria-label="Play all unselected parts together"/><label for="chk_playUnselected">Play all unselected parts together</label></div>
                </div>
                <br>
                <div class="form-group">
                    <label class="h5">Instruments to Describe:</label>
                    {% for instrument in score_info.instruments %}
                        <div class="checkbox"><input type="checkbox" name="instruments" id="instrument_{{ forloop.counter }}" value="{{ forloop.counter }}" checked="checked" aria-label="{{ instrument }}"><label for="instrument_{{ forloop.counter }}">{{ instrument }}</label></div>
                    {% endfor %}
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend class="h4 bold">Description Content</legend>
                 <div class="form-group">
                    <div class="checkbox"><input type="checkbox" name="chk_include_dynamics" id="chk_include_dynamics" value="checked" checked="checked" /><label for="chk_include_dynamics">Include dynamics (e.g., forte, piano)</label></div>
                    <div class="checkbox"><input type="checkbox" name="chk_include_ties" id="chk_include_ties" value="checked" checked="checked" /><label for="chk_include_ties">Include ties</label></div>
                    <div class="checkbox"><input type="checkbox" name="chk_include_rests" id="chk_include_rests" value="checked" checked="checked" /><label for="chk_include_rests">Include rests</label></div>
                    <div class="checkbox"><input type="checkbox" name="chk_include_arpeggios" id="chk_include_arpeggios" value="checked" checked="checked" /><label for="chk_include_arpeggios">Include arpeggio marks</label></div>
                    <div class="checkbox"><input type="checkbox" name="chk_describe_chords" id="chk_describe_chords" value="checked" checked="checked" /><label for="chk_describe_chords">Announce chords (e.g., '4-note chord')</label></div>
                </div>
                <div class="form-group mt-3">
                    <label for="repetition_mode">Repetition Description <button type="button" class="help-btn" aria-label="More info on repetition description" data-controls="repetition-help-text">?</button></label>
                    <select name="repetition_mode" id="repetition_mode" class="form-control">
                        <option value="none">None</option>
                        <option value="learning" selected>Learning Mode</option>
                        <option value="detailed">Detailed Analysis</option>
                    </select>
                    <div id="repetition-help-text" class="form-text text-muted mt-2 help-text-panel">
                        <ul class="list-unstyled mb-0 small">
                            <li><strong>Learning Mode:</strong> Only describes repetition of the immediately preceding bar.</li>
                            <li><strong>Detailed Analysis:</strong> Provides a summary of all repetition throughout the piece.</li>
                        </ul>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="mb-4">
                <legend class="h4 bold">Description Style &amp; Detailing</legend>
                <div class="form-group"><label for="bars_at_a_time">Bars at a time</label><select name="bars_at_a_time" id="bars_at_a_time" class="form-control"><option>1</option><option selected>2</option><option>4</option><option>8</option></select></div>
                <div class="form-group mt-3"><label for="beat_division">Group Beats By</label><select name="beat_division" id="beat_division" class="form-control">{% for option in score_info.beat_division_options %}<option value="{{ option.value }}" {% if loop.index == 2 %}selected{% endif %}>{{ option.display }}</option>{% endfor %}</select></div>
                <div class="form-group mt-3"><label for="pitch_description">Pitch Description</label><select name="pitch_description" id="pitch_description" class="form-control"><option value="noteName" selected>Note Names</option><option value="colourNotes">Coloured Notes</option><option value="phonetic">Phonetic Alphabet</option><option value="none">None</option></select></div>
                <div class="form-group mt-3"><label for="rhythm_description">Rhythm Description</label><select name="rhythm_description" id="rhythm_description" class="form-control"><option value="british" selected>British (crotchet)</option><option value="american">American (quarter note)</option><option value="none">None</option></select></div>
                <div class="form-group mt-3"><label for="octave_description">Octave Description</label><select name="octave_description" id="octave_description" class="form-control"><option value="name" selected>Name (mid, high)</option><option value="number">Number (4, 5)</option><option value="none">None</option></select></div>
                <div class="form-group mt-3"><label for="octave_announcement">Octave Announcement <button type="button" class="help-btn" aria-label="More info on octave announcement" data-controls="octave-help-text">?</button></label><select name="octave_announcement" id="octave_announcement" class="form-control"><option value="onChange" selected>On change</option><option value="brailleRules">Braille rules</option><option value="everyNote">Every note</option><option value="firstNote">First note of section</option></select>
                    <div id="octave-help-text" class="form-text text-muted mt-2 help-text-panel"><p class="small">Determines how often the octave (e.g. "high", "low") is mentioned.</p></div>
                </div>
                <div class="form-group mt-3"><label for="key_signature_accidentals">Key Signature Accidentals <button type="button" class="help-btn" aria-label="More info on key signature accidentals" data-controls="key-sig-help-text">?</button></label><select name="key_signature_accidentals" id="key_signature_accidentals" class="form-control"><option value="applied" selected>Applied to every note</option><option value="onChange">On change</option><option value="standard">Standard</option></select>
                    <div id="key-sig-help-text" class="form-text text-muted mt-2 help-text-panel"><p class="mb-1 small"><strong>Example:</strong> Key of E-flat. Notes are E‚ô≠, E‚ô≠, E‚ôÆ, E‚ô≠.</p><ul class="list-unstyled mb-0 small"><li><strong>Applied:</strong> "E flat, E flat, E natural, E flat"</li><li><strong>On change:</strong> "E flat, E, E natural, E flat"</li><li><strong>Standard:</strong> "E, E, E natural, E"</li></ul></div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                 <legend class="h4 bold">Advanced Detailing</legend>
                 <div class="form-group">
                    <label for="dot_position">Position of dot in dotted rhythms</label>
                    <select name="dot_position" id="dot_position" class="form-control">
                        <option value="before" selected>Before rhythm (e.g., dotted crotchet)</option>
                        <option value="after">After rhythm (e.g., crotchet dotted)</option>
                    </select>
                 </div>
                 <div class="form-group mt-3">
                    <label for="rhythm_announcement">Rhythm Announcement</label>
                    <select name="rhythm_announcement" id="rhythm_announcement" class="form-control">
                        <option value="onChange" selected>On change</option>
                        <option value="everyNote">Every note</option>
                    </select>
                 </div>
                 <div class="form-group mt-3">
                    <label for="octave_position">Octave Position</label>
                    <select name="octave_position" id="octave_position" class="form-control">
                        <option value="before" selected>Before pitch</option>
                        <option value="after">After pitch</option>
                    </select>
                 </div>
                 <div class="form-group mt-3">
                    <label for="accidental_style">Accidental Style</label>
                    <select name="accidental_style" id="accidental_style" class="form-control">
                        <option value="words" selected>Words (e.g., sharp, flat)</option>
                        <option value="symbols">Symbols (e.g., ‚ôØ, ‚ô≠)</option>
                    </select>
                 </div>
                 <div class="form-group mt-3">
                    <div class="checkbox">
                        <input type="checkbox" name="chk_enharmonic_conversion" id="chk_enharmonic_conversion" value="checked" />
                        <label for="chk_enharmonic_conversion">
                            Simplify complex accidentals
                            <button type="button" class="help-btn" aria-label="More info on enharmonic conversion" data-controls="enharmonic-help-text">?</button>
                        </label>
                    </div>
                    <div id="enharmonic-help-text" class="form-text text-muted mt-2 help-text-panel">
                        <p class="mb-1 small"><strong>Simplify Complex Accidentals</strong> converts hard-to-read notes to their simpler equivalents:</p>
                        <ul class="list-unstyled mb-0 small">
                            <li><strong>Double sharps:</strong> FùÑ™ becomes G, CùÑ™ becomes D, GùÑ™ becomes A</li>
                            <li><strong>Double flats:</strong> BùÑ´ becomes A, EùÑ´ becomes D, AùÑ´ becomes G</li>
                            <li><strong>Uncommon accidentals:</strong> E‚ôØ becomes F, B‚ôØ becomes C, C‚ô≠ becomes B, F‚ô≠ becomes E</li>
                        </ul>
                        <p class="small mb-0">This makes scores easier to read, especially for learners.</p>
                    </div>
                </div>
            </fieldset>

            <fieldset class="mt-4 p-3 border rounded">
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="chk_disable_all_coloring" name="chk_disable_all_coloring">
                        <label class="form-check-label" for="chk_disable_all_coloring">
                            <strong>Disable All Coloring</strong>
                            <br>
                            <small class="text-muted">Override all color settings - no pitch, rhythm, or octave coloring will be applied</small>
                        </label>
                    </div>
                </div>
                <div class="form-separator">Color Options</div>
                <legend class="h2 bold">Note Colouring</legend>
                <div class="form-group">
                    <label for="colour_style" class="h4">Colouring Style</label>
                    <select name="colour_style" id="colour_style" class="form-control">
                        <option value="none" selected>Off</option>
                        <option value="text">Colour the text</option>
                        <option value="background">Colour the background</option>
                    </select>
                </div>
                <div id="coloring-details-panel" style="display: none;">
                    <hr>
                    <h4 class="bold">Elements to Colour</h4>
                    <div class="form-group mt-3 p-3 border rounded">
                        <div class="d-flex align-items-center"><input type="checkbox" name="chk_colourPitch" id="chk_colourPitch" value="checked" checked><label for="chk_colourPitch" class="h5 mb-0 ml-2">Pitch</label><span id="preview-pitch" class="color-preview ml-auto">C</span></div>
                        <div id="pitch-colour-panel" class="mt-2">
                            <p class="small text-muted">Colour notes based on their pitch name (e.g., C, D, E).</p>
                            <div class="palette-container">
                                <fieldset class="palette-radios"><legend class="h5 bold">Palette</legend><div class="form-check"><input class="form-check-input" type="radio" name="colorProfile" id="profileDefault" value="default" checked><label class="form-check-label" for="profileDefault"><a href="https://drakemusicscotland.org/project/figurenotes/">Figurenotes</a> (Default)</label></div><div class="form-check"><input class="form-check-input" type="radio" name="colorProfile" id="profileClassic" value="classic"><label class="form-check-label" for="profileClassic">Classic (Newton)</label></div><div class="form-check"><input class="form-check-input" type="radio" name="colorProfile" id="profileCustom" value="custom"><label class="form-check-label" for="profileCustom">Custom</label></div></fieldset>
                                <div id="custom-color-pickers" class="palette-pickers"><h5 class="bold">Custom Colours</h5><div class="d-flex justify-content-between align-items-center my-1"><label for="color_C">Note C:</label><input type="color" id="color_C" name="color_C" value="#FF0000"></div><div class="d-flex justify-content-between align-items-center my-1"><label for="color_D">Note D:</label><input type="color" id="color_D" name="color_D" value="#A52A2A"></div><div class="d-flex justify-content-between align-items-center my-1"><label for="color_E">Note E:</label><input type="color" id="color_E" name="color_E" value="#808080"></div><div class="d-flex justify-content-between align-items-center my-1"><label for="color_F">Note F:</label><input type="color" id="color_F" name="color_F" value="#0000FF"></div><div class="d-flex justify-content-between align-items-center my-1"><label for="color_G">Note G:</label><input type="color" id="color_G" name="color_G" value="#000000"></div><div class="d-flex justify-content-between align-items-center my-1"><label for="color_A">Note A:</label><input type="color" id="color_A" name="color_A" value="#FFFF00"></div><div class="d-flex justify-content-between align-items-center my-1"><label for="color_B">Note B:</label><input type="color" id="color_B" name="color_B" value="#008000"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-3"><input type="checkbox" id="chk_show_advanced_colouring"><label for="chk_show_advanced_colouring">Customize Rhythm &amp; Octave Colours</label></div>
                    <div id="advanced-colouring-panel" class="mt-2" style="display: none;">
                        <div class="form-group mt-2 p-3 border rounded">
                            <div class="d-flex align-items-center">
                                <label for="rhythm_colour_mode" class="h5 mb-0">Rhythm</label>
                                <span id="preview-rhythm" class="color-preview ml-auto">Crotchet</span>
                            </div>
                            <select name="rhythm_colour_mode" id="rhythm_colour_mode" class="form-control mt-2">
                                <option value="none" selected>Off</option>
                                <option value="inherit">Inherit colour from Pitch</option>
                                <option value="custom">Use custom colours below</option>
                            </select>
                            <div id="rhythm-colour-panel" class="p-3 mt-2 border rounded" style="display: none;">
                                <h5 class="bold">Custom Rhythm Colours</h5>
                                <p class="small text-muted">Only rhythms found in this piece are shown below.</p>
                                {% if score_info.rhythm_range %}
                                    {% for rhythm in score_info.rhythm_range %}
                                    <div class="d-flex justify-content-between align-items-center my-1">
                                        <label for="color_rhythm_{{ rhythm.id_name }}">{{ rhythm.name|title }}:</label>
                                        <input type="color" id="color_rhythm_{{ rhythm.id_name }}" name="color_rhythm_{{ rhythm.id_name }}" value="{{ rhythm.default_color }}">
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="small">No unique rhythms found in this score to customize.</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group mt-3 p-3 border rounded">
                            <div class="d-flex align-items-center">
                                <label for="octave_colour_mode" class="h5 mb-0">Octave</label>
                                <span id="preview-octave" class="color-preview ml-auto">High</span>
                            </div>
                            <select name="octave_colour_mode" id="octave_colour_mode" class="form-control mt-2">
                                <option value="none" selected>Off</option>
                                <option value="inherit">Inherit colour from Pitch</option>
                                <option value="custom">Use custom colours below</option>
                            </select>
                            <div id="octave-colour-panel" class="p-3 mt-2 border rounded" style="display: none;">
                                <h5 class="bold">Custom Octave Colours</h5>
                                <p class="small text-muted">Only octaves found in this piece are shown below.</p>
                                {% if score_info.octave_range.max >= 5 %}
                                <div class="d-flex justify-content-between align-items-center my-2">
                                    <label for="color_octave_high">High (e.g., 5, 6, 7):</label>
                                    <input type="color" id="color_octave_high" name="color_octave_high" value="#FF4500">
                                </div>
                                {% endif %}
                                {% if score_info.octave_range.min <= 4 and score_info.octave_range.max >= 4 %}
                                <div class="d-flex justify-content-between align-items-center my-2">
                                    <label for="color_octave_mid">Mid (e.g., 4):</label>
                                    <input type="color" id="color_octave_mid" name="color_octave_mid" value="#B8860B">
                                </div>
                                {% endif %}
                                {% if score_info.octave_range.min <= 3 %}
                                <div class="d-flex justify-content-between align-items-center my-2">
                                    <label for="color_octave_low">Low (e.g., 1, 2, 3):</label>
                                    <input type="color" id="color_octave_low" name="color_octave_low" value="#4682B4">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </fieldset>

        </details>

        <div class="form-group text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Generate Talking Score</button>
        </div>
    </form>
</div>
{% endblock content %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // =================================================================
        // --- 1. SETUP & CONFIGURATION ---
        // =================================================================
        const LOCAL_STORAGE_KEY = 'talkingScoresSettings';
        
        const presetCards = {
            default: document.getElementById('preset-card-default'),
            notes_only: document.getElementById('preset-card-notes_only'),
            custom: document.getElementById('preset-card-custom')
        };
        const livePreviewContent = document.getElementById('live-preview-content');
        const activeProfileNameSpan = document.getElementById('active-profile-name');
        const allAdvancedControls = document.querySelectorAll('.advanced-options-container select, .advanced-options-container input[type="checkbox"]');
    
        const controlIds = {
            bars_at_a_time: 'bars_at_a_time', beatDivision: 'beat_division', rhythmDescription: 'rhythm_description',
            repetitionMode: 'repetition_mode', includeDynamics: 'chk_include_dynamics', octaveAnnouncement: 'octave_announcement',
            accidentalStyle: 'accidental_style', includeTies: 'chk_include_ties', includeRests: 'chk_include_rests',
            includeArpeggios: 'chk_include_arpeggios', pitch_description: 'pitch_description', octave_description: 'octave_description',
            describe_chords: 'chk_describe_chords',
            dot_position: 'dot_position', rhythm_announcement: 'rhythm_announcement', octave_position: 'octave_position',
            enharmonic_conversion: 'chk_enharmonic_conversion',
            key_signature_accidentals: 'key_signature_accidentals'
        };
    
        const presets = {
            'default': {
                bars_at_a_time: '2',
                rhythmDescription: 'british', pitch_description: 'noteName', octave_description: 'name',
                octave_position: 'before', repetitionMode: 'learning', includeDynamics: true, includeTies: true, 
                includeRests: true, includeArpeggios: true, describe_chords: true, accidentalStyle: 'words',
                enharmonic_conversion: false
            },
            'notes_only': {
                // ** THE FIX IS HERE **
                bars_at_a_time: '2',
                accidentalStyle: 'symbols',
                repetitionMode: 'none',
                rhythmDescription: 'none', pitch_description: 'noteName', octave_description: 'name',
                octave_position: 'before', includeDynamics: false, includeTies: false, 
                includeRests: false, includeArpeggios: false, describe_chords: false,
                enharmonic_conversion: true
            }
        };
    
        const sampleEvents = [
            { type: 'dynamic', value: 'crescendo' },
            { type: 'note', pitchName: 'C sharp', octaveNum: 4, rhythmType: 'quarter', dots: 0, arpeggio: true },
            { type: 'rest', rhythmType: 'eighth' },
            { type: 'note', pitchName: 'E', octaveNum: 4, rhythmType: 'eighth', dots: 0, tie: 'start' }
        ];
        const rhythmMap = {
            'british': { 'whole': 'Semibreve', 'half': 'Minim', 'quarter': 'Crotchet', 'eighth': 'Quaver' },
            'american': { 'whole': 'Whole note', 'half': 'Half note', 'quarter': 'Quarter note', 'eighth': 'Eighth note' }
        };
        const octaveNameMap = { 4: 'mid', 5: 'high' };
    
        // =================================================================
        // --- 2. CORE FUNCTIONS ---
        // =================================================================
    
        function generatePreviewHTML(settings) {
            let output = 'e.g., ';
            const eventStrings = [];
    
            sampleEvents.forEach(event => {
                if (event.type === 'rest' && !settings.includeRests) return;
                if (event.type === 'dynamic' && !settings.includeDynamics) return;
    
                let prefix = '', rhythmPart = '', pitchPart = '', octavePart = '', suffix = '';
    
                if (event.arpeggio && settings.includeArpeggios) prefix = 'Arpeggio ';
                
                if (settings.rhythmDescription !== 'none') {
                    let rhythmName = rhythmMap[settings.rhythmDescription]?.[event.rhythmType] || event.rhythmType;
                    if (event.dots > 0) rhythmPart = 'Dotted ' + rhythmName;
                    else rhythmPart = rhythmName;
                }
                
                if (settings.pitch_description !== 'none' || (event.type === 'rest' && settings.includeRests)) {
                    if (event.type === 'note') {
                        pitchPart = event.pitchName;
                        if (settings.octave_description === 'name') {
                            octavePart = octaveNameMap[event.octaveNum] || '';
                        } else if (settings.octave_description === 'number') {
                            octavePart = event.octaveNum.toString();
                        }
                    } else if (event.type === 'rest') {
                        pitchPart = 'rest';
                    }
                }
    
                if (event.type === 'dynamic') pitchPart = `[${event.value}]`;
                if (event.tie && settings.includeTies) suffix = `(tie ${event.tie})`;
                
                let finalParts;
                if (settings.octave_position === 'before') {
                    finalParts = [prefix, rhythmPart, octavePart, pitchPart, suffix];
                } else { // 'after'
                    finalParts = [prefix, rhythmPart, pitchPart, octavePart, suffix];
                }
                
                const fullEventString = finalParts.filter(Boolean).join(' ').trim();
                if (fullEventString) eventStrings.push(fullEventString);
            });
    
            output += eventStrings.join(', ');
            return `<em>${output}</em>`;
        }
        
        function updateLivePreview() {
            const activeProfile = matchCurrentSettingsToPreset();
            
            if (activeProfileNameSpan) {
                if (activeProfile === 'custom') {
                    activeProfileNameSpan.textContent = 'Custom';
                } else {
                    activeProfileNameSpan.textContent = presetCards[activeProfile].querySelector('.preset-card-title').textContent;
                }
            }
    
            const currentSettings = {};
            for (const key in controlIds) {
                const control = document.getElementById(controlIds[key]);
                if (control) {
                    currentSettings[key] = (control.type === 'checkbox') ? control.checked : control.value;
                }
            }
            if (livePreviewContent) {
                livePreviewContent.innerHTML = generatePreviewHTML(currentSettings);
            }
        }
    
        function applyPreset(presetName) {
            const settings = presets[presetName];
            if (!settings) return;
            
            for (const key in controlIds) {
                const control = document.getElementById(controlIds[key]);
                if (control) {
                    const defaultValue = control.type === 'checkbox' ? false : (control.options.length > 0 ? control.options[0].value : '');
                    const valueToSet = settings[key] !== undefined ? settings[key] : defaultValue;
                    
                    if (control.type === 'checkbox') {
                        control.checked = valueToSet;
                    } else {
                        control.value = valueToSet;
                    }
                }
            }
            
            document.getElementById(controlIds.octave_description).dispatchEvent(new Event('change'));
            document.getElementById(controlIds.rhythmDescription).dispatchEvent(new Event('change'));
        }
    
        function saveSettings() {
            const settingsToSave = {};
            for (const key in controlIds) {
                const control = document.getElementById(controlIds[key]);
                if (control) {
                    settingsToSave[key] = (control.type === 'checkbox') ? control.checked : control.value;
                }
            }
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(settingsToSave));
        }
    
        function loadSettings() {
            const savedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                for (const key in settings) {
                    const control = document.getElementById(controlIds[key]);
                    if (control && settings[key] !== undefined) {
                         if (control.type === 'checkbox') { control.checked = settings[key]; } 
                         else { control.value = settings[key]; }
                    }
                }
                return true;
            }
            return false;
        }
        
        function matchCurrentSettingsToPreset() {
            for (const presetName in presets) {
                const presetSettings = presets[presetName];
                let isMatch = true;
                for (const key in presetSettings) {
                    const control = document.getElementById(controlIds[key]);
                    if (!control) continue;
                    const currentValue = (control.type === 'checkbox') ? control.checked : control.value;
                    if (String(currentValue) !== String(presetSettings[key])) {
                        isMatch = false;
                        break; 
                    }
                }
                if (isMatch) {
                    return presetName;
                }
            }
            return 'custom';
        }
    
        function updateActiveCard(activePreset) {
            for (const presetName in presetCards) {
                if (presetCards[presetName]) {
                    presetCards[presetName].classList.toggle('active', presetName === activePreset);
                }
            }
        }
    
        function updateFormVisibility() {
            const rhythmValue = document.getElementById(controlIds.rhythmDescription).value;
            const octaveValue = document.getElementById(controlIds.octave_description).value;
    
            [controlIds.dot_position, controlIds.rhythm_announcement].forEach(id => {
                const control = document.getElementById(id);
                if(control) control.closest('.form-group').style.display = (rhythmValue === 'none') ? 'none' : 'block';
            });
    
            const octaveShouldHide = octaveValue === 'none';
            const posControl = document.getElementById(controlIds.octave_position);
            if (posControl) {
                posControl.closest('.form-group').style.display = octaveShouldHide ? 'none' : 'block';
            }
            const annControl = document.querySelector('[name="octave_announcement"]');
            if (annControl) {
                annControl.closest('.form-group').style.display = octaveShouldHide ? 'none' : 'block';
            }
        }
        
        function setupHelpButtons() {
            document.querySelectorAll('.help-btn').forEach(btn => {
                const panelId = btn.dataset.controls;
                const panel = document.getElementById(panelId);
                if (!panel) return;
        
                btn.addEventListener('click', () => {
                    const isVisible = panel.style.display === 'block';
                    panel.style.display = isVisible ? 'none' : 'block';
                    btn.classList.toggle('active', !isVisible);
                });
            });
        }
    
    
        // =================================================================
        // --- 3. EVENT LISTENERS & INITIALIZATION ---
        // =================================================================
        document.querySelector('form.form-horizontal').addEventListener('submit', saveSettings);
    
        for (const presetName in presets) {
            const card = presetCards[presetName];
            if (card && card.id !== 'preset-card-custom') {
                card.addEventListener('click', () => applyPreset(presetName));
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); applyPreset(presetName); }
                });
            }
        }
    
        allAdvancedControls.forEach(control => {
            control.addEventListener('change', () => {
                const matchedPreset = matchCurrentSettingsToPreset();
                updateActiveCard(matchedPreset);
                updateFormVisibility();
                updateLivePreview();
            });
        });
        
        setupHelpButtons();
    
        if (!loadSettings()) {
            applyPreset('default');
        } else {
            const matchedPreset = matchCurrentSettingsToPreset();
            updateActiveCard(matchedPreset);
        }
        updateFormVisibility();
        updateLivePreview(); 
    
        const elements = {
            colourStyleSelect: document.getElementById('colour_style'),
            coloringDetailsPanel: document.getElementById('coloring-details-panel'),
            chkColourPitch: document.getElementById('chk_colourPitch'),
            pitchColourPanel: document.getElementById('pitch-colour-panel'),
            profileRadios: document.querySelectorAll('input[name="colorProfile"]'),
            customProfileRadio: document.getElementById('profileCustom'),
            customColorPickers: document.querySelectorAll('#custom-color-pickers input[type="color"]'),
            chkShowAdvanced: document.getElementById('chk_show_advanced_colouring'),
            advancedPanel: document.getElementById('advanced-colouring-panel'),
            rhythmColourModeSelect: document.getElementById('rhythm_colour_mode'),
            rhythmColourPanel: document.getElementById('rhythm-colour-panel'),
            octaveColourModeSelect: document.getElementById('octave_colour_mode'),
            octaveColourPanel: document.getElementById('octave-colour-panel'),
            previewPitch: document.getElementById('preview-pitch'),
            previewRhythm: document.getElementById('preview-rhythm'),
            previewOctave: document.getElementById('preview-octave')
        };
        const colorProfiles = {
            default: { C: "#FF0000", D: "#A52A2A", E: "#808080", F: "#0000FF", G: "#000000", A: "#FFFF00", B: "#008000" },
            classic: { C: "#FF0000", D: "#FFA500", E: "#FFFF00", F: "#008000", G: "#0000FF", A: "#4B0082", B: "#EE82EE" }
        };
        function getContrastColor(hex) { if (!hex || hex.length < 4) return '#000000'; const hexValue = hex.startsWith('#') ? hex.slice(1) : hex; try { const r = parseInt(hexValue.substring(0, 2), 16); const g = parseInt(hexValue.substring(2, 4), 16); const b = parseInt(hexValue.substring(4, 6), 16); const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.5 ? '#000000' : '#FFFFFF'; } catch (e) { return '#FFFFFF'; } }
        function applyNoteColorProfile(profileName) { const profile = colorProfiles[profileName]; if (!profile) return; elements.customColorPickers.forEach(picker => { const note = picker.id.split('_')[1]; if (profile[note]) picker.value = profile[note]; }); }
        function updateColorFormDisplay() { const isColoringOn = elements.colourStyleSelect.value !== 'none'; elements.coloringDetailsPanel.style.display = isColoringOn ? 'block' : 'none'; const isPitchOn = elements.chkColourPitch.checked; elements.pitchColourPanel.style.display = isPitchOn && isColoringOn ? 'block' : 'none'; const isCustomProfile = elements.customProfileRadio.checked; elements.customColorPickers.forEach(picker => { picker.disabled = !isCustomProfile; }); const showAdvanced = elements.chkShowAdvanced.checked; elements.advancedPanel.style.display = showAdvanced && isColoringOn ? 'block' : 'none'; elements.rhythmColourPanel.style.display = elements.rhythmColourModeSelect.value === 'custom' ? 'block' : 'none'; elements.octaveColourPanel.style.display = elements.octaveColourModeSelect.value === 'custom' ? 'block' : 'none'; updateAllPreviews(); }
        function updateAllPreviews() { const style = elements.colourStyleSelect.value; const pitchColor = document.getElementById('color_C').value; const applyStyle = (el, color, isEnabled) => { if (!el) return; el.style.backgroundColor = ''; el.style.color = ''; el.style.borderColor = 'transparent'; if (style === 'none' || !isEnabled || !color) return; if (style === 'background') { el.style.backgroundColor = color; el.style.color = getContrastColor(color); el.style.borderColor = '#888'; } else { el.style.color = color; } }; applyStyle(elements.previewPitch, pitchColor, elements.chkColourPitch.checked); const rhythmMode = elements.rhythmColourModeSelect.value; let rhythmColor = rhythmMode === 'inherit' ? pitchColor : null; if (rhythmMode === 'custom') { const firstRhythmPicker = document.querySelector('#rhythm-colour-panel input[type="color"]'); if (firstRhythmPicker) rhythmColor = firstRhythmPicker.value; } applyStyle(elements.previewRhythm, rhythmColor, rhythmMode !== 'none'); const octaveMode = elements.octaveColourModeSelect.value; let octaveColor = octaveMode === 'inherit' ? pitchColor : null; if (octaveMode === 'custom') { const firstOctavePicker = document.querySelector('#octave-colour-panel input[type="color"]'); if (firstOctavePicker) octaveColor = firstOctavePicker.value; } applyStyle(elements.previewOctave, octaveColor, octaveMode !== 'none'); }
        [ elements.colourStyleSelect, elements.chkColourPitch, elements.chkShowAdvanced, elements.rhythmColourModeSelect, elements.octaveColourModeSelect ].forEach(el => { if(el) el.addEventListener('change', updateColorFormDisplay); });
        document.querySelectorAll('input[type="color"]').forEach(picker => { picker.addEventListener('input', updateAllPreviews); });
        elements.profileRadios.forEach(radio => { radio.addEventListener('change', () => { if (radio.value !== 'custom') { applyNoteColorProfile(radio.value); } updateColorFormDisplay(); }); });
        applyNoteColorProfile('default');
        updateColorFormDisplay();
    });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const disableAllCheckbox = document.getElementById('chk_disable_all_coloring');
            const colorInputs = document.querySelectorAll('input[type="color"], input[name*="colour"], input[name*="color"]');
            
            function toggleColorInputs() {
                const isDisabled = disableAllCheckbox.checked;
                colorInputs.forEach(input => {
                    input.disabled = isDisabled;
                    input.style.opacity = isDisabled ? '0.5' : '1';
                });
            }
            
            disableAllCheckbox.addEventListener('change', toggleColorInputs);
            toggleColorInputs(); // Initial state
        });
        </script>
{% endblock %}